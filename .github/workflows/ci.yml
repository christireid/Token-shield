name: CI

on:
  push:
    branches: [main, "claude/**"]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - run: npm ci
      - run: npx vitest run --coverage
      - name: Check coverage thresholds
        run: |
          # Enforce minimum coverage â€” prevents regression
          npx vitest run --coverage --coverage.thresholds.statements=70 --coverage.thresholds.branches=60 --coverage.thresholds.functions=60 --coverage.thresholds.lines=70 2>&1 | tail -5
        if: matrix.node-version == 20
      - run: npx tsc --noEmit

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx eslint lib/tokenshield/
      - run: npx prettier --check .

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx tsup

      # Validate package contents before publishing
      - name: Validate package contents
        run: |
          npm pack --dry-run 2>&1 | tee /tmp/pack-output.txt
          # Ensure key files are included
          grep -q "dist/index.js" /tmp/pack-output.txt
          grep -q "dist/index.cjs" /tmp/pack-output.txt
          grep -q "dist/index.d.ts" /tmp/pack-output.txt

      # Verify bundle size doesn't regress
      - name: Check bundle size
        run: |
          ESM_SIZE=$(stat -c%s dist/index.js 2>/dev/null || stat -f%z dist/index.js)
          CJS_SIZE=$(stat -c%s dist/index.cjs 2>/dev/null || stat -f%z dist/index.cjs)
          echo "ESM: ${ESM_SIZE} bytes, CJS: ${CJS_SIZE} bytes"
          # Fail if ESM exceeds 500KB (generous ceiling)
          if [ "$ESM_SIZE" -gt 500000 ]; then
            echo "::error::ESM bundle exceeds 500KB limit ($ESM_SIZE bytes)"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7
